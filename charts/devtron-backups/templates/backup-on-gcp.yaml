{{- if .Values.global.GCP.enabled }}
{{ if semverCompare ">=1.21-0" .Capabilities.KubeVersion.GitVersion -}}
apiVersion: batch/v1
{{ else -}}
apiVersion: batch/v1beta1
{{ end -}}
kind: CronJob
metadata:
  name: postgres-app-backup-cronjob
  namespace: devtroncd
spec:
  schedule: {{ .Values.global.schedule }}
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
          - name: postgres-app-backup-cronjob
            image: postgres:11.3
            volumeMounts:
            - mountPath: /tmp
              name: psql-volume
            env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  key: PG_PASSWORD
                  name: {{ .Values.postgres_backup.secretName }}
            imagePullPolicy: Always
            args:
            - /bin/bash
            - -c
            - pg_dumpall -h postgresql-postgresql.devtroncd -p 5432 -U postgres --no-privileges > /tmp/backup.tar;
          containers:
          - name: gcp-cli-for-download
            image: quay.io/devtron/k8s-utils:gcp-cli-ubuntu
            volumeMounts:
            - mountPath: /tmp
              name: psql-volume
            - name: gcp-secret-file
              mountPath: /secret
              readOnly: true
            env:
            {{- with .Values.global.GCP }}
            - name: GCP_BUCKET_NAME
              value: "gs://{{ .GCP_BUCKET_NAME }}/"
              {{- end }}
            imagePullPolicy: Always
            args:
            - /bin/bash
            - -c
            - date1=$(date +%Y%m%d-%H%M); mv /tmp/backup.tar /tmp/backup-$date1.tar; gcloud auth activate-service-account --key-file /secret/secret-file; gsutil cp /tmp/backup-$date1.tar $GCP_BUCKET_NAME/;
          volumes:
          - name: psql-volume
            emptyDir: {}
          - name: gcp-secret-file
            secret: 
              secretName: gcp-secret
              items: 
                - key: gcloud.json
                  path: secret-file
          restartPolicy: OnFailure
---
{{ if semverCompare ">=1.21-0" .Capabilities.KubeVersion.GitVersion -}}
apiVersion: batch/v1
{{ else -}}
apiVersion: batch/v1beta1
{{ end -}}
kind: CronJob
metadata:
    name: argocd-app-backup-cronjob
    namespace: devtroncd
spec:
  schedule: {{ .Values.global.schedule }}
  jobTemplate:
    spec:
      template:
        spec:
          initContainers:
          - name: argocd-app-backup-job
            image: argoproj/argocd:v1.8.1
            volumeMounts:
            - mountPath: /cache
              name: argocd-volume
            env:
            imagePullPolicy: Always
            args:
            - /bin/bash
            - -c
            - argocd-util export --namespace devtroncd > /cache/backup.yaml;
          containers:
          - name: gcp-cli-for-upload
            image: quay.io/devtron/k8s-utils:gcp-cli-ubuntu
            volumeMounts:
            - mountPath: /cache
              name: argocd-volume
            - name: gcp-secret-file
              mountPath: /secret
              readOnly: true
            env:
            {{- with .Values.global.GCP }}
            - name: GCP_BUCKET_NAME
              value: "gs://{{ .GCP_BUCKET_NAME }}/"
            {{- end }}
            imagePullPolicy: Always
            args:
            - /bin/bash
            - -c
            - date1=$(date +%Y%m%d-%H%M); mv /cache/backup.yaml /cache/backup-$date1.yaml; gcloud auth activate-service-account --key-file /secret/secret-file ; gsutil cp /cache/backup-$date1.yaml $GCP_BUCKET_NAME/;
          volumes:
          - name: argocd-volume
            emptyDir: {}
          - name: gcp-secret-file
            secret: 
              secretName: gcp-secret
              items: 
                - key: gcloud.json
                  path: secret-file
          restartPolicy: OnFailure
          serviceAccountName: {{ .Values.argocd_backup.serviceAccountName }}
{{- end }}